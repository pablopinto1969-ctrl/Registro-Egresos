<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Egresos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b0c10" />

  <!-- Ícono $ simple (favicon) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%2314473d"/><text x="50" y="65" font-size="60" text-anchor="middle" fill="white" font-family="sans-serif">$</text></svg>' />

  <style>
    :root {
      --bg:#0b0c10;
      --card:#13151a;
      --muted:#2b2f3a;
      --txt:#e6e7ea;
      --accent:#16a34a;
    }
    * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--txt); }
    header {
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#000;
      position:sticky;
      top:0;
      z-index:1;
    }
    header h1 { margin:0; font-size:18px; }
    .wrap { max-width:900px; margin:0 auto; padding:16px; }
    .card {
      background:var(--card);
      border-radius:16px;
      border:1px solid var(--muted);
      padding:16px;
      margin-bottom:16px;
    }
    label { font-size:12px; opacity:.85; margin-bottom:4px; display:block; }
    input, select, textarea {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--muted);
      background:#0f1218;
      color:var(--txt);
      font-size:14px;
    }
    textarea { min-height:70px; resize:vertical; }
    button {
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--muted);
      background:#0f1218;
      color:var(--txt);
      cursor:pointer;
      font-size:14px;
    }
    button.primary {
      background:var(--accent);
      border-color:#0a7f36;
      color:#fff;
    }
    button + button { margin-left:8px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td {
      padding:8px;
      border-bottom:1px solid var(--muted);
      text-align:left;
    }
    th { font-size:11px; text-transform:uppercase; opacity:.8; }
    .footer {
      margin-top:16px;
      font-size:11px;
      opacity:.7;
      text-align:center;
    }
    @media (max-width:600px) {
      header h1 { font-size:16px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Registro de Egresos</h1>
    <div>
      <button id="btn-export">Exportar CSV</button>
      <button id="btn-clear">Vaciar</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div style="margin-bottom:10px;">
        <label for="fecha">Fecha</label>
        <input type="date" id="fecha" />
      </div>

      <div style="margin-bottom:10px;">
        <label for="categoria">Categoría</label>
        <select id="categoria">
          <!-- EDITA LAS CATEGORÍAS AQUÍ -->
          <optgroup label="Frecuentes">
            <option value="Movilización" selected>Movilización</option>
            <option value="Comida Afuera">Comida Afuera</option>
            <option value="Regalos">Regalos</option>
            <option value="Alimentación">Alimentación</option>
          </optgroup>
          <optgroup label="Otras">
            <option value="Casa">Casa</option>
            <option value="Salud">Salud</option>
            <option value="Otros">Otros</option>
          </optgroup>
        </select>
      </div>

      <div style="margin-bottom:10px;">
        <label for="monto">Monto (USD)</label>
        <input id="monto" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
      </div>

      <div style="margin-bottom:10px;">
        <label for="medio">Medio de pago</label>
        <select id="medio">
          <option value="Tarjeta">Tarjeta</option>
          <option value="Transferencia">Transferencia</option>
          <option value="Efectivo">Efectivo</option>
        </select>
      </div>

      <div style="margin-bottom:10px;">
        <label for="proyecto">Proyecto / Obra</label>
        <select id="proyecto">
          <!-- EDITA LOS PROYECTOS AQUÍ -->
          <option value="">(Sin proyecto)</option>
          <option value="Gastos Personales">Gastos Personales</option>
          <option value="Giro del Negocio">Giro del Negocio</option>
          <option value="Casa">Casa</option>
          <option value="Clase EPN">Clase EPN</option>
          <option value="Clase UTE">Clase UTE</option>
        </select>
      </div>

      <div style="margin-bottom:10px;">
        <label for="nota">Nota (detalle / comprobante)</label>
        <textarea id="nota" placeholder="Descripción breve del gasto"></textarea>
      </div>

      <div style="margin-top:8px;">
        <button id="btn-guardar" class="primary">Guardar egreso</button>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Categoría</th>
            <th>Monto</th>
            <th>Medio</th>
            <th>Proyecto</th>
            <th>Nota</th>
            <th>ID</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer">
      Funciona sin internet (PWA).<br>
      CSV: Fecha;Categoría;Monto;MedioPago;Nota;Proyecto;ID
    </div>
  </div>

<script>
const KEY = "egresos_registro_v1";
const headers = ["Fecha","Categoría","Monto","MedioPago","Nota","Proyecto","ID"];

const $ = sel => document.querySelector(sel);
const tbody = $("#tbody");

function hoyISO() {
  const d = new Date();
  const off = d.getTimezoneOffset();
  const d2 = new Date(d.getTime() - off*60000);
  return d2.toISOString().slice(0,10);
}

function load() {
  try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
  catch { return []; }
}

function save(data) {
  localStorage.setItem(KEY, JSON.stringify(data));
}

function rowHTML(item) {
  return `
    <tr>
      <td>${item.Fecha || ""}</td>
      <td>${escapeHtml(item.Categoría || "")}</td>
      <td>${Number(item.Monto || 0).toFixed(2)}</td>
      <td>${escapeHtml(item.MedioPago || "")}</td>
      <td>${escapeHtml(item.Proyecto || "")}</td>
      <td>${escapeHtml(item.Nota || "")}</td>
      <td>${escapeHtml(item.ID || "")}</td>
    </tr>`;
}

function render() {
  const data = load();
  tbody.innerHTML = data.map(rowHTML).join("");
}

function escapeHtml(s) {
  return String(s).replace(/[&<>\"']/g, m => (
    {"&":"&amp;","<":"&lt;"," >":"&gt;",'"':"&quot;","'":"&#039;"}[m] || m
  ));
}

function collect() {
  const Fecha = $("#fecha").value || hoyISO();
  const catSel = $("#categoria");
  let Categoría = catSel.value || "Movilización";
  const Monto = parseFloat($("#monto").value || "0");
  const MedioPago = $("#medio").value;
  const Proyecto = $("#proyecto").value.trim();
  const Nota = $("#nota").value.trim();
  const ID = Date.now().toString(36);
  return {Fecha, Categoría, Monto, MedioPago, Nota, Proyecto, ID};
}

function exportCSV() {
  const rows = load();
  const delim = ";";

  const norm = s => String(s ?? "").normalize("NFC");
  const esc = v => {
    v = norm(v).replaceAll('"','""');
    if (/[\";\n\r;]/.test(v)) v = `"${v}"`;
    return v;
  };

  let lines = [];
  lines.push(headers.map(h => esc(h)).join(delim));
  for (const r of rows) {
    const vals = headers.map(h => {
      let v = r[h];
      if (h === "Monto") v = Number(v || 0).toFixed(2); // decimal con punto
      return esc(v);
    });
    lines.push(vals.join(delim));
  }

  const csvText = "\uFEFF" + lines.join("\r\n"); // BOM + CRLF
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const today = new Date().toISOString().slice(0,10);
  a.href = url;
  a.download = `egresos_${today}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// registrar service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js").catch(console.error);
}

document.addEventListener("DOMContentLoaded", () => {
  $("#fecha").value = hoyISO();
  render();

  $("#btn-guardar").addEventListener("click", () => {
    const item = collect();
    const data = load();
    data.unshift(item);
    save(data);
    render();
    $("#monto").value = "";
    $("#nota").value = "";
    $("#proyecto").value = "";
    $("#categoria").value = "Movilización";
  });

  $("#btn-export").addEventListener("click", exportCSV);

  $("#btn-clear").addEventListener("click", () => {
    if (confirm("¿Vaciar todos los registros guardados en este dispositivo?")) {
      save([]);
      render();
    }
  });
});
</script>
</body>
</html>

